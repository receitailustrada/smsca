<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel da APS Cruz Alta 2026 (Padrão IPM)</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
    :root {
        --ipm-blue: #005a9c;
        --ipm-dark-blue: #003d6b;
        --ipm-bg: #f5f7fa;
        --ipm-text: #333333;
        --ipm-border: #e0e0e0;

        --btn-facil: #ff9800;
        --success: #2e7d32;
        --white: #ffffff;
    }

    * { box-sizing: border-box; outline: none; }

    body {
        margin: 0; padding: 0;
        font-family: 'Roboto', sans-serif;
        background: var(--ipm-bg);
        color: var(--ipm-text);
        padding-bottom: 60px;
    }

    header {
        background: #ffffff;
        padding: 10px 20px;
        border-bottom: 4px solid var(--ipm-blue);
        display: flex;
        align-items: center;
        justify-content: space-between; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        min-height: 80px;
    }

    .header-text {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .header-text h1 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--ipm-blue);
        font-weight: 700;
        text-transform: uppercase;
        line-height: 1.2;
    }
    .header-text h2 {
        margin: 0;
        font-size: 1rem;
        color: #666;
        font-weight: 400;
        margin-top: 2px;
    }

    header img {
        max-height: 50px;
        max-width: 50%;
        height: auto;
        object-fit: contain;
    }

    .nav-tabs {
        background: var(--white);
        border-bottom: 1px solid var(--ipm-border);
        display: flex;
        justify-content: center;
        gap: 2px;
        padding-top: 10px;
        flex-wrap: wrap;
    }
    .tab-btn {
        background: #f0f0f0;
        border: 1px solid var(--ipm-border);
        border-bottom: none;
        padding: 12px 30px;
        font-family: 'Roboto', sans-serif;
        font-weight: 500;
        color: #666;
        cursor: pointer;
        border-radius: 4px 4px 0 0;
        transition: 0.2s;
        font-size: 0.95rem;
        display: flex; align-items: center; gap: 8px;
    }
    .tab-btn:hover { background: #e6e6e6; }
    .tab-btn.active {
        background: var(--white);
        color: var(--ipm-blue);
        font-weight: 700;
        border-top: 3px solid var(--ipm-blue);
        margin-bottom: -1px;
        z-index: 2;
    }

    .controls {
        max-width: 1440px;
        margin: 20px auto;
        padding: 0 15px;
    }

    .facilitator-box {
        background: #fff3e0;
        border: 1px solid #ffe0b2;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
    }
    .btn-help {
        background: var(--btn-facil);
        color: #fff;
        border: none;
        padding: 12px 25px;
        border-radius: 999px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: inline-flex; align-items: center;
        gap: 10px;
        text-transform: uppercase;
        transition: transform 0.1s;
    }
    .btn-help:hover { background: #f57c00; }
    .btn-help:active { transform: translateY(2px); }

    .search-wrapper { position: relative; margin-bottom: 12px; }
    .search-wrapper input {
        width: 100%;
        padding: 12px 12px 12px 40px;
        border: 1px solid #ccc;
        border-radius: 999px;
        font-size: 1rem;
        background: white;
    }
    .search-wrapper input:focus { border-color: var(--ipm-blue); box-shadow: 0 0 0 2px rgba(0,90,156,0.2); }
    .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

    /* MAIS RESPIRO E SEM "ACAVALAR" */
    .scroll-filter {
        display: flex;
        overflow-x: auto;
        gap: 8px;
        padding: 8px 2px 10px 2px;
        scroll-snap-type: x mandatory;
    }
    .scroll-filter::-webkit-scrollbar { height: 8px; }
    .scroll-filter::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 999px; }

    /* CHIPS COM EFEITO (ESTILO SWATCH) */
    .filter-pill {
        position: relative;
        white-space: nowrap;
        background: #ffffff;
        border: 1.5px solid var(--btnColor, #cbd5e1);
        color: var(--btnColorText, #475569);
        padding: 8px 14px;
        padding-left: 34px;              /* espaço para o quadrado */
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 800;
        letter-spacing: 0.3px;
        cursor: pointer;
        user-select: none;
        transition: border 300ms ease, padding 300ms ease, background-color 150ms ease, color 150ms ease;
        scroll-snap-align: start;
        box-shadow: none;
    }

    /* QUADRADO (SWATCH) DO CHIP */
    .filter-pill::before,
    .filter-pill::after {
        content: "";
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        left: 12px;
        width: 11px;
        height: 11px;
        border-radius: 3px;
        background: var(--btnColor, #cbd5e1);
        border: 1px solid rgba(0,0,0,0.18); /* BORDA DO QUADRADO */
        transition: transform 200ms cubic-bezier(0.41,-0.23,0.55,1.24), background-color 200ms cubic-bezier(0.41,-0.23,0.55,1.24);
    }

    /* EFEITO DA “FAIXA” NO HOVER (BORDER-LEFT AUMENTA) */
    .filter-pill:hover {
        border-left-width: 12px;
        padding-left: 28px;
        background: #f8fafc;
    }
    .filter-pill:active {
        border-left-width: 22px;
        transition: border 150ms ease, padding 150ms ease;
    }

    /* EFEITO DO SWATCH “ENTRANDO” NO HOVER */
    .filter-pill:hover::before {
        transform: translate(-17px, -50%);
        background: #ffffff;
    }
    .filter-pill:hover::after {
        transform: translate(-17px, -50%);
        clip-path: polygon(50% 0, 100% 0, 100% 98%, 50% 100%);
    }

    /* ATIVO: FUNDO DA COR, TEXTO BRANCO */
    .filter-pill.active {
        background: var(--btnColor, var(--ipm-blue));
        color: #ffffff;
        border-color: transparent;
    }
    .filter-pill.active::before,
    .filter-pill.active::after {
        background: #ffffff;
        border-color: rgba(255,255,255,0.55);
    }

    /* ACORDEÃO + LISTA POR MINIATURAS */
    .quick-finder {
        margin-top: 10px;
        background: #ffffff;
        border: 1px solid var(--ipm-border);
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .quick-finder.hidden { display:none; }
    .quick-finder details {
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #f0f0f0;
        background: #fbfcfe;
    }
    .quick-finder summary {
        cursor: pointer;
        padding: 12px 12px;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
        list-style: none;
    }
    .quick-finder summary::-webkit-details-marker { display:none; }
    .quick-finder .summary-left { display:flex; gap:10px; align-items:center; }
    .quick-finder .summary-left i { color: var(--ipm-blue); }
    .quick-finder .summary-right {
        color: #94a3b8;
        font-size: 0.9rem;
        display: inline-flex;
        gap: 8px;
        align-items: center;
    }
    .quick-finder .content {
        padding: 10px 10px 12px 10px;
        border-top: 1px solid #eef2f7;
    }

    .mini-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .mini-esf {
        border: 1px solid #e8edf4;
        border-radius: 12px;
        background: #ffffff;
        padding: 8px;
        cursor: pointer;
        transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 8px;
        user-select: none;
    }
    .mini-esf:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
    .mini-thumb {
        height: 72px;
        border-radius: 10px;
        background-size: cover;
        background-position: center;
        border: 2px solid #f7f9fc;
        position: relative;
        overflow: hidden;
    }
    .mini-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 0.65rem;
        font-weight: 800;
        letter-spacing: 0.4px;
        color: #fff;
        padding: 4px 8px;
        border-radius: 999px;
        backdrop-filter: blur(4px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        max-width: calc(100% - 16px);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .mini-label {
        font-weight: 800;
        font-size: 0.78rem;
        line-height: 1.2;
        text-transform: uppercase;
        color: #334155;
        min-height: 2.2em;
    }
    .mini-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
    }

    /* BOTÕES DA MINIATURA: MENOS SOMBRA, MENOR */
    .mini-btn {
        border: 1px solid rgba(0,0,0,0.12);
        background: rgba(255,255,255,0.92);
        border-radius: 999px;
        padding: 5px 9px;
        cursor: pointer;
        font-weight: 900;
        font-size: 0.72rem;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        transition: background-color 0.15s ease;
        color: #334155;
        box-shadow: none;
    }
    .mini-btn:hover { background: #f1f5f9; }
    .mini-btn i { font-size: 0.8rem; }

    /* MINI LIST (PILLS TEXTUAIS) */
    .mini-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
        align-items: center;
    }

    /* MINI-PILL IGUAL CHIP, SÓ MENOR */
    .mini-pill {
        position: relative;
        border: 1.5px solid var(--btnColor, #cbd5e1);
        background: #ffffff;
        color: var(--btnColorText, #334155);
        border-radius: 999px;
        padding: 7px 12px;
        padding-left: 32px;
        cursor: pointer;
        font-weight: 900;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        transition: border 300ms ease, padding 300ms ease, background-color 150ms ease, color 150ms ease;
        user-select: none;
        box-shadow: none;
    }
    .mini-pill::before,
    .mini-pill::after {
        content: "";
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        left: 12px;
        width: 10px;
        height: 10px;
        border-radius: 3px;
        background: var(--btnColor, #cbd5e1);
        border: 1px solid rgba(0,0,0,0.18);
        transition: transform 200ms cubic-bezier(0.41,-0.23,0.55,1.24), background-color 200ms cubic-bezier(0.41,-0.23,0.55,1.24);
    }
    .mini-pill:hover {
        border-left-width: 12px;
        padding-left: 26px;
        background: #f8fafc;
    }
    .mini-pill:hover::before { transform: translate(-17px, -50%); background: #ffffff; }
    .mini-pill:hover::after {
        transform: translate(-17px, -50%);
        clip-path: polygon(50% 0, 100% 0, 100% 98%, 50% 100%);
    }
    .mini-pill.active {
        background: var(--btnColor, var(--ipm-blue));
        color: #ffffff;
        border-color: transparent;
    }
    .mini-pill.active::before,
    .mini-pill.active::after {
        background: #ffffff;
        border-color: rgba(255,255,255,0.55);
    }

    .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        max-width: 1440px; margin: 0 auto; padding: 0 15px;
    }

    .card {
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        background: white;
        transition: transform 0.2s;
        padding: 8px;
    }
    .card:hover { transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

    .card-header-img {
        height: 240px;
        background-size: cover;
        background-position: center;
        position: relative;
        border-radius: 12px;
        border: 2px solid #f7f9fc;
        cursor: pointer;
        overflow: hidden;
    }

    .card-floating-tag {
        position: absolute;
        top: 10px;
        right: 10px;
        color: white;
        padding: 5px 12px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.6rem;
        letter-spacing: 0.5px;
        backdrop-filter: blur(4px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        z-index: 10;
        max-width: calc(100% - 20px);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* BOTÃO PNG NO CARD GRANDE: MENOR E SOMBRA MAIS SUAVE */
    .img-download-btn {
        position: absolute;
        left: 10px;
        top: 10px;
        z-index: 11;
        border: none;
        cursor: pointer;
        color: #ffffff;
        font-weight: 800;
        padding: 6px 9px;
        border-radius: 999px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        backdrop-filter: blur(6px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        transition: 0.15s;
    }
    .img-download-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }
    .img-download-btn i { font-size: 0.6rem; }

    .img-download-hint {
        position: absolute;
        left: 10px;
        bottom: 10px;
        z-index: 11;
        background: rgba(0,0,0,0.45);
        color: #ffffff;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.6rem;
        backdrop-filter: blur(4px);
        max-width: calc(100% - 20px);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .card-body {
        padding: 10px 5px 5px 5px;
        display: flex;
        flex-direction: column; gap: 8px;
    }

    .card-title-strip {
        background: var(--ipm-blue);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.8rem;
        text-align: center;
        text-transform: uppercase;
        margin-bottom: 5px;
        line-height: 1.3;
        cursor: pointer;
        user-select: none;
    }

    .card-row {
        font-size: 0.95rem;
        color: #555;
        border-bottom: 1px dashed #f0f0f0;
        padding: 6px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .card-row i { font-size: 1.1rem; width: 20px; text-align: center; }

    .status-pill {
        margin-top: 10px;
        border-radius: 50px;
        padding: 8px 20px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        width: fit-content;
    }
    .pill-agendado { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
    .pill-concluido { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .pill-definir { background: #f5f5f5; color: #757575; border: 1px solid #e0e0e0; }

    #loading { text-align: center; padding: 40px; color: #777; font-size: 0.9rem; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--ipm-blue); border-radius: 50%; width: 30px; height: 30px;
        animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: none; justify-content: center; align-items: center; padding: 15px;
    }
    .modal-content {
        background: white; width: 100%; max-width: 600px;
        border-radius: 4px; padding: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        max-height: 90vh; overflow-y: auto;
    }
    .modal-header {
        background: var(--ipm-blue); color: white; padding: 15px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body { padding: 20px; }

    .big-btn {
        padding: 15px; border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px;
        transition: 0.1s; background: #f9f9f9;
    }
    .big-btn:hover { background: #e3f2fd; border-color: var(--ipm-blue); }
    .big-btn i { font-size: 1.8rem; color: var(--ipm-blue); }
    .big-btn span { font-weight: 500; font-size: 1rem; color: #333; }

    .hidden { display: none; }
</style>
</head>

<body>
<header>
    <div class="header-text">
        <h1>Atenção Primária em Saúde</h1>
        <h2>Educação permanente 2026</h2>
    </div>
    
    <img src="https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/alto-cab-logotipos.png" alt="APS Cruz Alta">
</header>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('educacao')">
        <i class="fa-solid fa-graduation-cap"></i> Educação
    </button>
    <button class="tab-btn" onclick="switchTab('visitas')">
        <i class="fa-solid fa-house-medical"></i> Cronograma VD
    
  
    <button class="tab-btn" onclick="window.open('https://www.cruzaltars.com.br/início/hiperdia', '_blank')">
        <i class="fa-solid fa-heart"></i> Hiperdia
    </button>

    <button class="tab-btn" onclick="window.open('https://www.cruzaltars.com.br/início/feridas', '_blank')">
        <i class="fa-solid fa-kit-medical"></i> Feridas
    </button>

    <button class="tab-btn" onclick="window.open('https://www.cruzaltars.com.br/início/pse', '_blank')">
        <i class="fa-solid fa-hands-holding-child"></i> PSE
    </button>

    <button class="tab-btn" onclick="window.open('https://www.cruzaltars.com.br/início/IMPLANON', '_blank')">
        <i class="fa-solid fa-syringe"></i>I - IMPLANON
    </button>

    <button class="tab-btn" onclick="window.open('https://www.cruzaltars.com.br/início/pré-natal', '_blank')">
        <i class="fa-solid fa-person-pregnant"></i> Pré-natal
    </button>

    <button class="tab-btn" onclick="window.open('https://www.cruzaltars.com.br/início/puericultura', '_blank')">
        <i class="fa-solid fa-child-reaching"></i> Puericultura
    </button>
</div>

<div class="controls">
    <div class="facilitator-box">
        <p style="margin: 0 0 10px 0; color: #666; font-size: 0.9rem;">
            <i class="fa-solid fa-circle-info"></i> Está com dúvida de onde clicar?
        </p>
        <button class="btn-help" onclick="openModal()">
            <i class="fa-regular fa-hand-point-right"></i> Clique aqui para encontrar sua unidade ou perfil
        </button>
    </div>

    <div class="search-wrapper">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="searchInput" placeholder="Digite aqui o que você procura..." oninput="debouncedFilter()">
    </div>

    <div id="filter-container" class="scroll-filter"></div>

    <div id="quickFinder" class="quick-finder hidden">
        <details id="quickFinderDetails">
            <summary>
                <span class="summary-left">
                    <i class="fa-solid fa-building"></i>
                    <span id="quickFinderTitle">Pesquisar por ESF (miniaturas)</span>
                </span>
                <span class="summary-right">
                    <span id="quickFinderCount"></span>
                    <i class="fa-solid fa-chevron-down"></i>
                </span>
            </summary>
            <div class="content">
                <div style="font-size:0.9rem;color:#64748b;">
                    Clique em uma miniatura para filtrar. O botão de download salva a imagem do ESF em PNG.
                </div>

                <div class="mini-list" id="miniListText"></div>

                <div class="mini-grid" id="miniGrid"></div>
            </div>
        </details>
    </div>
</div>

<div id="loading">
    <div class="spinner"></div>
    <p>Carregando dados do sistema...</p>
</div>

<div id="error-msg" style="display:none; color:red; text-align:center;"></div>

<div id="grid-content" class="grid-container hidden"></div>

<div id="helpModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; font-size: 1.1rem;">Seleção Rápida</h3>
            <button onclick="document.getElementById('helpModal').style.display='none'" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-top:0; color:#666;">Selecione quem você é ou o que procura:</p>
            <div id="modal-options"></div>
        </div>
    </div>
</div>

<script>
    const LINK_CSV_EDUCACAO = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJEERpaf6eqezf9_2HtAn05EHXs-ShHfnvW-Na01IwfydNTZ424c4THbCFtUk_-IZ0lNKK-BDjDlBX/pub?gid=1482009319&single=true&output=csv";
    const LINK_CSV_VISITAS  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJEERpaf6eqezf9_2HtAn05EHXs-ShHfnvW-Na01IwfydNTZ424c4THbCFtUk_-IZ0lNKK-BDjDlBX/pub?gid=136584672&single=true&output=csv";

    // CORES ATUALIZADAS (Enfermeiro=Roxo, Médico=Cinza Chumbo)
    const CAT_COLORS = {
        'Técnicos de enfermagem': { color: '#27ae60', icon: 'fa-user-nurse' },
        
        // Enfermeiros (Roxo) - Cobre Plural e Singular
        'Enfermeiros': { color: '#d63384', icon: 'fa-user-nurse' },
        'Enfermeiro':  { color: '#d63384', icon: 'fa-user-nurse' },

        // Médicos (Cinza Chumbo) - Cobre Plural e Singular
        'Médicos': { color: '#546e7a', icon: 'fa-user-doctor' }, 
        'Médico':  { color: '#546e7a', icon: 'fa-user-doctor' },
        
        'Dentistas': { color: '#0277bd', icon: 'fa-tooth' },
        'Recepcionistas': { color: '#ef6c00', icon: 'fa-clipboard-user' },
        'ACS': { color: '#d84315', icon: 'fa-users' },
        'E-multi': { color: '#00695c', icon: 'fa-people-arrows' },
        'ESF': { color: '#c62828', icon: 'fa-house-medical' }
    };

    const ESF_COLOR_OVERRIDES = {
        'SÃO GENARO': '#c62828',
        'VILA NOVA': '#006FFF'
    };
    const ESF_IMAGES = {
        'SÃO GENARO': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--xii-sg.png',
        'VILA NOVA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf---x-vnmif.png',
        'SANTA RITA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--v-sr.png',
        'ABEGAI': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--ii--ab.png',
        'ALVORADA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--III-alvorada.png',
        'BOA PARADA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf---boaparada.png',
        'BONINI': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--xxi-bonini.png',
        'BRUM': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/ESF-VI-Bairro-Brum-I.png',
        'CENTRO': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--XIX-centro.png',
        'FÁTIMA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf-xv-fatima.png',
        'JARDIM PRIMAVERA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--IX-bjp.png',
        'PENHA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/ESF---XI-penha.png',
        'VIDA NOVA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/ESF-vida-nova-1280.png',
        'SANTA TEREZINHA II': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/ESF--VI-Santa-Terezinha-II.png',
        'SÃO JOSÉ': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--VIII-bsj.png',
        'PROGRESSO': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--XIII-bp.png',
        'ACELINO FLORES': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--xiv-af.png',
        'TORÍBIO': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--I-tv.png',
        'LIZABEL': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--XVI-lz.png',
        'VILA ROCHA': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf-vila-rocha.png',
        'DNER': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/esf--IV-dner.png',
        'BENJAMIN NOTT': 'https://raw.githubusercontent.com/receitailustrada/smsca/refs/heads/main/eap-bn.png',
        'DEFAULT': 'https://picsum.photos/seed/padrao/800/400'
    };

    // PALETA PANTONE-LIKE (ORDEM CONSISTENTE PELO NOME DA ESF)
    const PANTONE_BASE = [
        { name: 'Blue Iris', h: 235 },
        { name: 'Indigo',    h: 220 },
        { name: 'Teal',      h: 190 },
        { name: 'Green',     h: 140 },
        { name: 'Lime',      h:  95 },
        { name: 'Amber',     h:  40 },
        { name: 'Rose',      h: 350 }
    ];

    let ESF_ORDER = [];           // lista única, ordenada
    const ESF_PANTONE_MAP = {};   // { "ESF X ...": "#hex" }

    function buildEsfPantoneMap() {
        ESF_ORDER = [...new Set(dbVisitas.map(v => normalizeEsfName(v.esf)).filter(Boolean))].sort();
        ESF_ORDER.forEach((esfName, idx) => {
            const base = PANTONE_BASE[idx % PANTONE_BASE.length];
            const tier = Math.floor(idx / PANTONE_BASE.length);   // varia o tom a cada volta
            const light = Math.min(42 + tier * 6, 62);            // 42..62
            const hex = hslToHex(base.h, 70, light);
            ESF_PANTONE_MAP[esfName] = hex;
        });
    }

    let dbEducacao = [];
    let dbVisitas = [];
    let currentTab = 'educacao';
    let activeFilter = 'Todos';

    let _debounceTimer = null;
    const ESF_COLOR_CACHE = {};

    window.onload = function() {
    // 1. Verifica se viemos da tela de seleção (Workspace)
    const contextoSalvo = localStorage.getItem("RXI_CONTEXT");
    
    if (contextoSalvo) {
        const dados = JSON.parse(contextoSalvo);
        console.log("Ambiente configurado para:", dados.n);
        
        // Se o usuário selecionou uma ESF, definimos como filtro ativo
        if(dados.k === 'esf') {
            // Ajusta o nome para bater com o filtro (ex: Remove "ESF " se necessário ou mantém)
            // No seu código antigo, o filtro espera algo como "ESF ALVORADA" ou apenas "ALVORADA"
            // Vamos tentar passar o nome completo
            activeFilter = dados.n.toUpperCase(); 
            
            // Forçamos a aba de visitas se for uma ESF, para ver o cronograma dela?
            // Se quiser forçar a aba de visitas, descomente a linha abaixo:
            // currentTab = 'visitas'; 
        }
    }

    carregarDados(); 
};
    function debouncedFilter() {
        if (_debounceTimer) clearTimeout(_debounceTimer);
        _debounceTimer = setTimeout(() => filterData(), 80);
    }

    function parseDate(str) {
        if (!str) return null;
        if (str.includes('/')) {
            const parts = str.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        if (str.includes('-')) {
            const parts = str.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        return new Date(str);
    }

    function carregarDados() {
        Promise.all([
            fetchData(LINK_CSV_EDUCACAO),
            fetchData(LINK_CSV_VISITAS)
        ]).then(results => {
            const [csvEdu, csvVisitas] = results;

            dbEducacao = csvEdu.slice(1).map(row => ({
                cat: (row[0] || '').trim(), data: row[1], 
                hora: row[2], tema: row[3], local: row[4], prof: row[5]
            })).filter(r => r.tema && r.data);

            dbVisitas = csvVisitas.slice(1).map(row => ({
                esf: row[0], data: row[1], turno: row[3], hora: row[4]
            })).filter(r => r.esf && r.data);

            dbEducacao.sort((a,b) => parseDate(a.data) - parseDate(b.data));
            dbVisitas.sort((a,b) => parseDate(a.data) - parseDate(b.data));
            
            buildEsfPantoneMap();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('grid-content').classList.remove('hidden');
            switchTab('educacao');
// ... (dentro do .then do carregarDados, perto da linha 725)

            document.getElementById('grid-content').classList.remove('hidden');
            
            // LÓGICA DE INTEGRAÇÃO RXI
            const ctx = JSON.parse(localStorage.getItem("RXI_CONTEXT") || "{}");
            
            // Se tivermos um contexto de ESF e estivermos na aba de visitas (ou se você quiser forçar)
            if (ctx && ctx.k === 'esf') {
                 // Se quiser que ao selecionar ESF já caia na aba de cronograma:
                 switchTab('visitas'); // Muda para a aba de visitas
                 
                 // Aplica o filtro visualmente e nos dados
                 setTimeout(() => {
                    // Tenta encontrar o botão do filtro correspondente
                    const filters = document.querySelectorAll('.filter-pill');
                    let targetBtn = null;
                    
                    // Procura o botão que contém o nome da ESF selecionada
                    filters.forEach(btn => {
                        if(btn.innerText.toUpperCase().includes(ctx.n.toUpperCase().replace('ESF ', ''))) {
                            targetBtn = btn;
                        }
                    });

                    if(targetBtn) {
                        targetBtn.click(); // Simula o clique para ativar cores e lógica
                    } else {
                        // Fallback se não achar o botão
                        activeFilter = ctx.n;
                        renderData();
                    }
                 }, 500); // Pequeno delay para garantir que os botões de filtro foram renderizados
            } else {
                switchTab('educacao'); // Comportamento padrão
            }
// ... fim do then
        }).catch(err => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-msg').innerText = "Erro ao carregar dados.";
            document.getElementById('error-msg').style.display = 'block';
        });
    }

    function fetchData(url) {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true,
                complete: function(results) { resolve(results.data); },
                error: function(err) { reject(err); }
            });
        });
    }

    function switchTab(tab) {
        currentTab = tab;
        activeFilter = 'Todos';
        document.getElementById('searchInput').value = '';
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        const btnIndex = tab === 'educacao' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
        renderFilters();
        renderQuickFinder();
        renderData();
    }

    function getCatColor(cat) {
        const cfg = CAT_COLORS[cat];
        return cfg ? cfg.color : '#7f8c8d';
    }

    function getEsfKey(esfRaw) {
        if (!esfRaw) return '';
        return esfRaw.toUpperCase().replace('ESF', '').trim();
    }

    function normalizeEsfName(esfRaw) {
        if (!esfRaw) return '';
        return esfRaw.toUpperCase().replace(/\s+/g,' ').trim();
    }

    function stableHash(str) {
        let h = 2166136261;
        for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 16777619);
        }
        return (h >>> 0);
    }

    function hslToHex(h, s, l) {
        s /= 100;
        l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
        const toHex = x => Math.round(x * 255).toString(16).padStart(2, '0');
        return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
    }

    function autoEsfColor(key) {
        const clean = normalizeEsfName(key);
        if (!clean) return '#546e7a';
        if (ESF_COLOR_OVERRIDES[clean]) return ESF_COLOR_OVERRIDES[clean];
        if (ESF_COLOR_CACHE[clean]) return ESF_COLOR_CACHE[clean];
        const hash = stableHash(clean);
        const hue = hash % 360;
        const sat = 72;
        const lig = 42;
        const hex = hslToHex(hue, sat, lig);
        ESF_COLOR_CACHE[clean] = hex;
        return hex;
    }

    function getEsfColor(esfName) {
        const keyFull = normalizeEsfName(esfName || '');
        if (keyFull && ESF_COLOR_OVERRIDES[keyFull]) return ESF_COLOR_OVERRIDES[keyFull];

        const keyShort = getEsfKey(esfName);
        if (keyShort && ESF_COLOR_OVERRIDES[keyShort]) return ESF_COLOR_OVERRIDES[keyShort];

        if (keyFull && ESF_PANTONE_MAP[keyFull]) return ESF_PANTONE_MAP[keyFull];

        // fallback
        if (keyFull) return autoEsfColor(keyFull);
        if (keyShort) return autoEsfColor(keyShort);
        return '#546e7a';
    }

    function renderFilters() {
        const container = document.getElementById('filter-container');
        container.innerHTML = '';

        const btnAll = document.createElement('button');
        btnAll.className = 'filter-pill';
        btnAll.innerText = 'Todos';
        btnAll.dataset.filterValue = 'Todos';
        btnAll.style.setProperty('--btnColor', 'var(--ipm-blue)');
        btnAll.onclick = function() { applyFilter('Todos', this); };
        container.appendChild(btnAll);

        let filters;
        if (currentTab === 'educacao') {
            filters = [...new Set(dbEducacao.map(i => i.cat))];
        } else {
            filters = [...new Set(dbVisitas.map(i => i.esf))].sort();
        }

        filters.forEach(f => {
            if(!f) return;
            const btn = document.createElement('button');
            btn.className = 'filter-pill';
            btn.dataset.filterValue = f;
            btn.innerText = currentTab === 'educacao' ? f : f.replace('ESF ', '');

            let c;
            if (currentTab === 'educacao') {
                c = getCatColor(f);
            } else {
                c = getEsfColor(f);
            }
            btn.style.setProperty('--btnColor', c);
            btn.style.borderColor = c;
            btn.style.color = c;

            btn.onclick = function() { applyFilter(f, this); };
            container.appendChild(btn);
        });
        applyFilter('Todos', btnAll);
    }

    function applyFilter(val, el) {
        activeFilter = val;
        const pills = document.querySelectorAll('.filter-pill');
        pills.forEach(pill => {
            const fVal = pill.dataset.filterValue || 'Todos';
            pill.classList.remove('active');

            let c = 'var(--ipm-blue)';
            if (fVal !== 'Todos') c = (currentTab === 'educacao') ? getCatColor(fVal) : getEsfColor(fVal);

            pill.style.setProperty('--btnColor', c);
            pill.style.borderColor = c;

            // estado “inativo” mantém texto colorido
            pill.style.backgroundColor = '#ffffff';
            pill.style.color = c;
        });

        let activePill = el;
        if (!activePill) {
            // Tenta achar pelo valor exato
            activePill = [...pills].find(p => (p.dataset.filterValue || 'Todos') === val);
            
            // Fallback: Tenta achar removendo o 's' final (singular/plural)
            if(!activePill) {
                const searchVal = val.endsWith('s') ? val.slice(0, -1) : val;
                activePill = [...pills].find(p => (p.dataset.filterValue || '').includes(searchVal));
            }
        }

        if (activePill) {
            let fVal = activePill.dataset.filterValue || val;
            let c = (fVal === 'Todos') ? 'var(--ipm-blue)' : ((currentTab === 'educacao') ? getCatColor(fVal) : getEsfColor(fVal));
            activePill.classList.add('active');
            activePill.style.setProperty('--btnColor', c);
        }

        renderData();
    }

    function filterData() { renderData(); }

    function renderQuickFinder() {
        const quick = document.getElementById('quickFinder');
        const title = document.getElementById('quickFinderTitle');
        const count = document.getElementById('quickFinderCount');
        const miniGrid = document.getElementById('miniGrid');
        const miniListText = document.getElementById('miniListText');
        const details = document.getElementById('quickFinderDetails');
        if (currentTab !== 'visitas') {
            quick.classList.add('hidden');
            return;
        }

        quick.classList.remove('hidden');
        title.textContent = "Pesquisar por ESF (miniaturas)";
        miniGrid.innerHTML = '';
        miniListText.innerHTML = '';

        const uniqueEsf = [...new Set(dbVisitas.map(v => normalizeEsfName(v.esf)).filter(Boolean))].sort();
        count.textContent = uniqueEsf.length ?
            (uniqueEsf.length + " unidades") : "0 unidades";

        const allPill = document.createElement('button');
        allPill.className = 'mini-pill';
        allPill.textContent = 'TODAS';
        allPill.style.setProperty('--btnColor', 'var(--ipm-blue)');
        allPill.style.borderColor = 'var(--ipm-blue)';
        allPill.onclick = () => { applyFilter('Todos'); document.getElementById('searchInput').value=''; renderData(); };
        miniListText.appendChild(allPill);

        uniqueEsf.forEach(esfName => {
            const c = getEsfColor(esfName);
            const img = getImage(esfName);

            const pill = document.createElement('button');
            pill.className = 'mini-pill';
            pill.textContent = (esfName || '').replace('ESF ', '');
            pill.style.setProperty('--btnColor', c);
            pill.style.borderColor = c;
            pill.style.color = c;
            pill.onclick = () => {
                applyFilter(esfName);
                document.getElementById('searchInput').value = '';
                details.open = false;
                renderData();
            };
            miniListText.appendChild(pill);

            const mini = document.createElement('div');
            mini.className = 'mini-esf';
            mini.style.borderColor = hexToRgba(c, 0.35);

            mini.innerHTML = `
                <div class="mini-thumb" style="background-image:url('${img}');">
                    <div class="mini-badge" style="background:${hexToRgba(c,0.85)};">${(esfName || '').split('-')[0].trim()}</div>
                </div>
                <div class="mini-label">${(esfName || '').replace('ESF ', '')}</div>
                <div class="mini-actions">
                    <button class="mini-btn" type="button" title="Filtrar por esta unidade">
                        <i class="fa-solid fa-filter"></i> Filtrar
                    </button>
                    <button class="mini-btn" type="button" title="Baixar imagem em PNG">
                        <i class="fa-solid fa-download"></i> PNG
                    </button>
                </div>
            `;
            const btnFilter = mini.querySelectorAll('.mini-btn')[0];
            const btnPng = mini.querySelectorAll('.mini-btn')[1];

            btnFilter.onclick = (e) => {
                e.stopPropagation();
                applyFilter(esfName);
                document.getElementById('searchInput').value = '';
                details.open = false;
                renderData();
            };

            btnPng.onclick = async (e) => {
                e.stopPropagation();
                await downloadEsfPng(img, esfName);
            };

            mini.onclick = () => {
                applyFilter(esfName);
                document.getElementById('searchInput').value = '';
                details.open = false;
                renderData();
            };

            miniGrid.appendChild(mini);
        });
    }

    function renderData() {
        const grid = document.getElementById('grid-content');
        grid.innerHTML = '';
        const term = (document.getElementById('searchInput').value || '').toLowerCase();
        const dataSet = currentTab === 'educacao' ? dbEducacao : dbVisitas;
        
        // CORREÇÃO DA BUSCA: Normalização para evitar erro singular/plural
        const normalize = (str) => (str || '').toLowerCase().trim().replace(/s$/, '');

        const filtered = dataSet.filter(item => {
            let matchFilter = activeFilter === 'Todos';
            if (!matchFilter) {
                if(currentTab === 'educacao') {
                    // Compara usando a normalização (ignora 's' final)
                    matchFilter = normalize(item.cat) === normalize(activeFilter);
                }
                else {
                    matchFilter = normalizeEsfName(item.esf) === normalizeEsfName(activeFilter);
                }
            }
            let txt = currentTab === 'educacao'
                ? (item.tema + ' ' + item.local + ' ' + item.prof + ' ' + item.data)
                : (item.esf + ' ' + item.data + ' ' + item.turno + ' ' + item.hora);
            return matchFilter && (txt || '').toLowerCase().includes(term);
        });

        if (!filtered.length) {
            grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999"><p>Nenhum resultado encontrado.</p></div>`;
            return;
        }

        filtered.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            const status = getStatus(item.data);

            if (currentTab === 'educacao') {
                const cfg = CAT_COLORS[item.cat] || { color:'#7f8c8d', icon:'fa-user-tag' };
                const catColor = cfg.color;

                card.innerHTML = `
                    <div class="card-body" style="border-top: 4px solid ${catColor}; padding-top: 15px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="tag" style="background:${hexToRgba(catColor,0.1)}; color:${catColor}; padding:6px 10px; border-radius:999px; font-weight:800; font-size:0.75rem;">
                                ${item.cat}
                            </span>
                            <small style="color:#999">${formatDate(item.data)}</small>
                        </div>
                        <h3 style="color:${catColor}; margin: 10px 0;">${item.tema}</h3>
                        <div class="card-row"><i class="fa-solid ${cfg.icon}" style="color:${catColor}"></i> ${item.prof || ''}</div>
                        <div class="card-row"><i class="fa-regular fa-clock" style="color:${catColor}"></i> ${item.hora || ''}</div>
                        <div class="card-row"><i class="fa-solid fa-location-dot" style="color:${catColor}"></i> ${item.local || ''}</div>

                        <div class="status-pill ${status.cls === 'st-agendado' ?
                            'pill-agendado' : (status.cls === 'st-concluido' ? 'pill-concluido' : 'pill-definir')}">
                            <i class="fa-solid ${status.icon}"></i> ${status.label}
                        </div>
                    </div>`;
            } else {
                const esfName = normalizeEsfName(item.esf);
                const esfColor = getEsfColor(esfName);
                const img = getImage(esfName);

                let tagText = (esfName || '').split('-')[0].trim();
                const tagBgColor = hexToRgba(esfColor, 0.85);

                let pillClass = 'pill-definir';
                if(status.cls === 'st-agendado') pillClass = 'pill-agendado';
                if(status.cls === 'st-concluido') pillClass = 'pill-concluido';

                const dlBtnBg = hexToRgba(esfColor, 0.80);

                card.innerHTML = `
                    <div class="card-header-img"
                         style="background-image: url('${img}');"
                         title="Clique para baixar o PNG"
                         onclick="downloadEsfPng('${img}', '${escapeJs(esfName)}')">
                        <button class="img-download-btn" type="button"
                                style="background:${dlBtnBg};"
                                onclick="event.stopPropagation(); downloadEsfPng('${img}', '${escapeJs(esfName)}')">
                            <i class="fa-solid fa-download"></i> PNG
                        </button>

                        <div class="card-floating-tag" style="background-color: ${tagBgColor};">
                            ${tagText}
                        </div>

                        <div class="img-download-hint">
                            Clique na imagem para baixar
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="card-title-strip"
                             style="background-color: ${esfColor};"
                             title="Clique para filtrar por esta unidade"
                             onclick="applyFilter('${escapeJs(esfName)}'); document.getElementById('searchInput').value=''; renderData();">
                            ${esfName}
                        </div>

                        <div class="card-row">
                            <i class="fa-regular fa-calendar-days" style="color:${esfColor}"></i>
                            <strong>${formatDate(item.data)}</strong>
                        </div>
                        <div class="card-row">
                            <i class="fa-solid fa-sun" style="color:${esfColor}"></i>
                            Turno: ${item.turno || ''}
                        </div>
                        <div class="card-row">
                            <i class="fa-regular fa-clock" style="color:${esfColor}"></i>
                            ${item.hora || ''}
                        </div>

                        <div class="status-pill ${pillClass}">
                            <i class="fa-solid ${status.icon}"></i> ${status.label}
                        </div>
                    </div>`;
            }

            grid.appendChild(card);
        });
    }

    function formatDate(iso) {
        if(!iso || (typeof iso === 'string' && iso.toLowerCase().includes('definir'))) return 'A definir';
        if(iso.includes('/')) return iso;
        const parts = iso.split('-');
        if (parts.length !== 3) return iso;
        const [y,m,d] = parts;
        return `${d}/${m}/${y}`;
    }

    function getStatus(dt) {
        if(!dt || (typeof dt === 'string' && dt.toLowerCase().includes('definir'))) {
            return { cls:'st-definir', label:'A Definir', icon:'fa-calendar-plus'};
        }
        const d = parseDate(dt);
        if(!d || isNaN(d.getTime())) {
            return { cls:'st-definir', label:'A Definir', icon:'fa-calendar-plus'};
        }
        const h = new Date();
        h.setHours(0,0,0,0);
        if(d < h) return {cls:'st-concluido', label:'Concluído', icon:'fa-check'};
        if(d.getTime() === h.getTime()) return {cls:'st-concluido', label:'É Hoje!', icon:'fa-bell'};
        return {cls:'st-agendado', label:'Agendado', icon:'fa-clock'};
    }

    function getImage(n) {
        if (!n) return ESF_IMAGES['DEFAULT'];
        let cleanName = normalizeEsfName(n).replace('ESF', '').trim();
        if (ESF_IMAGES[cleanName]) return ESF_IMAGES[cleanName];
        for (let key in ESF_IMAGES) {
            if (key !== 'DEFAULT' && cleanName.includes(key)) {
                return ESF_IMAGES[key];
            }
        }
        return ESF_IMAGES['DEFAULT'];
    }

    function hexToRgba(hex, alpha) {
        if (!hex || typeof hex !== 'string') return `rgba(0,0,0,${alpha || 1})`;
        hex = hex.replace('#','');
        if (hex.length === 3) {
            hex = hex.split('').map(c => c + c).join('');
        }
        const num = parseInt(hex, 16);
        if (isNaN(num)) return `rgba(0,0,0,${alpha || 1})`;
        const r = (num >> 16) & 255;
        const g = (num >> 8) & 255;
        const b = num & 255;
        return `rgba(${r},${g},${b},${alpha})`;
    }

    function sanitizeFilename(name) {
        return (name || 'ESF')
            .toString()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-zA-Z0-9_\- ]/g, '')
            .trim()
            .replace(/\s+/g, '_');
    }

    function escapeJs(str) {
        return (str || '').toString().replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    }

    async function downloadEsfPng(url, esfName) {
        try {
            const fileBase = sanitizeFilename(esfName || 'ESF');
            const filename = fileBase + ".png";

            const res = await fetch(url, { mode: 'cors' });
            if (!res.ok) throw new Error('fetch_failed');
            const blob = await res.blob();

            const a = document.createElement('a');
            const objectUrl = URL.createObjectURL(blob);
            a.href = objectUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(objectUrl);
        } catch (e) {
            window.open(url, '_blank');
        }
    }

    function openModal() {
        const d = document.getElementById('modal-options');
        d.innerHTML='';

        if(currentTab==='educacao') {
            const roles = [
                {t:"Sou Médico(a)", k:"Médicos"},
                {t:"Sou Enfermeiro(a)", k:"Enfermeiros"},
                {t:"Sou Téc. Enfermagem", k:"Técnicos de enfermagem"},
                {t:"Sou Dentista", k:"Dentistas"},
                {t:"Sou da Recepção", k:"Recepcionistas"},
                {t:"Sou ACS", k:"ACS"},
                {t:"Sou da Equipe Multidisciplinar", k:"E-multi"}
            ];
            roles.forEach(r => {
                const color = getCatColor(r.k);
                d.innerHTML+=`<div class="big-btn" onclick="applyFilter('${escapeJs(r.k)}')"
                    style="border-color:${hexToRgba(color,0.4)}; background:${hexToRgba(color,0.05)};">
                    <i class="fa-solid ${CAT_COLORS[r.k] ? CAT_COLORS[r.k].icon : 'fa-user'}" style="color:${color}"></i>
                    <span>${r.t}</span>
                </div>`;
            });
        } else {
            d.innerHTML = `
                <div class="big-btn" onclick="applyFilter('Todos'); document.getElementById('searchInput').value=''; renderData();">
                    <i class="fa-solid fa-list-ul"></i>
                    <span>Ver Todas as Unidades</span>
                </div>
                <div class="big-btn" onclick="document.getElementById('quickFinderDetails').open=true; document.getElementById('helpModal').style.display='none';">
                    <i class="fa-solid fa-building"></i>
                    <span>Abrir pesquisa por miniaturas (ESF)</span>
                </div>`;
        }

        document.getElementById('helpModal').style.display='flex';
    }
</script>
</body>
</html>